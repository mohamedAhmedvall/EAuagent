{
  "name": "SOMEI — Plan de Renouvellement Réseau Eau",

  // Image Microsoft prébuilt : git, curl, python 3.11 déjà inclus
  // → aucun build Docker, aucun appel apt-get bloqué par le proxy
  "image": "mcr.microsoft.com/devcontainers/python:3.11",

  "workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",
  "remoteUser": "vscode",

  // Ports: FastAPI (8000) + Streamlit (8501)
  "forwardPorts": [8000, 8501],
  "portsAttributes": {
    "8000": {
      "label": "API FastAPI",
      "onAutoForward": "notify"
    },
    "8501": {
      "label": "IHM Streamlit",
      "onAutoForward": "openBrowser"
    }
  },

  // Proxy corporate SOMEI — disponible dès le démarrage du conteneur
  "containerEnv": {
    "HTTP_PROXY":  "http://pxy-smi-user.somei.intranet:8080",
    "HTTPS_PROXY": "http://pxy-smi-user.somei.intranet:8080",
    "http_proxy":  "http://pxy-smi-user.somei.intranet:8080",
    "https_proxy": "http://pxy-smi-user.somei.intranet:8080",
    "NO_PROXY":    "localhost,127.0.0.1,.somei.intranet",
    "NODE_EXTRA_CA_CERTS":         "/etc/ssl/certs/ca-certificates.crt",
    "NODE_TLS_REJECT_UNAUTHORIZED": "0"
  },
  "remoteEnv": {
    "HTTP_PROXY":  "http://pxy-smi-user.somei.intranet:8080",
    "HTTPS_PROXY": "http://pxy-smi-user.somei.intranet:8080",
    "http_proxy":  "http://pxy-smi-user.somei.intranet:8080",
    "https_proxy": "http://pxy-smi-user.somei.intranet:8080",
    "NO_PROXY":    "localhost,127.0.0.1,.somei.intranet",
    "REQUESTS_CA_BUNDLE":          "/etc/ssl/certs/ca-certificates.crt",
    "SSL_CERT_FILE":               "/etc/ssl/certs/ca-certificates.crt",
    "NODE_EXTRA_CA_CERTS":         "/etc/ssl/certs/ca-certificates.crt",
    "NODE_TLS_REJECT_UNAUTHORIZED": "0"
  },

  // apt-get fonctionne ici car containerEnv (proxy) est déjà injecté
  "postCreateCommand": "sudo apt-get update && sudo apt-get install -y coinor-cbc && pip install --no-cache-dir -r requirements.txt",

  // Démarre automatiquement l'API et l'IHM
  "postStartCommand": "bash .devcontainer/start_services.sh",

  "customizations": {
    "vscode": {
      "extensions": [
        "ms-python.python",
        "ms-python.vscode-pylance",
        "ms-toolsai.jupyter",
        "ms-python.black-formatter",
        "Anthropic.claude-code"
      ],
      "settings": {
        "python.defaultInterpreterPath": "/usr/local/bin/python",
        "python.terminal.activateEnvironment": false,
        "editor.formatOnSave": true,
        "[python]": {
          "editor.defaultFormatter": "ms-python.black-formatter"
        },
        "http.proxy": "http://pxy-smi-user.somei.intranet:8080",
        "http.proxyStrictSSL": false
      }
    }
  }
}
